#!/usr/bin/env bash

set -euo pipefail
set -x

bindir=$( cd "${0%/*}" && pwd )

cluster="${CLUSTER:-routekicking}"

# make sure a k3d cluster exists
if ! k3d cluster list "$cluster" >/dev/null 2>/dev/null; then
    k3d cluster create "$cluster"
else
    k3d kubeconfig merge "$cluster"
    kubectl config use-context "k3d-${cluster}"
fi

# install linkerd
"$bindir/linkerd" check --pre
"$bindir/linkerd" install --crds | kubectl apply -f -
"$bindir/linkerd" install | kubectl apply -f -
"$bindir/linkerd" check

# install viz
"$bindir/linkerd" viz install | kubectl apply -f -
"$bindir/linkerd" viz check